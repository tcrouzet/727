<!-- Slideshow -->

{%- assign page_name = page.permalink -%}

{%- if page_name -%}
  {%- assign first_char = page_name | slice: 0 -%}
  {%- assign last_char = page_name | slice: -1 -%}
  
  {%- if first_char == '/' -%}
    {%- assign page_name = page_name | remove_first: '/' -%}
  {%- endif -%}
  
  {%- if last_char == '/' -%}
    {%- assign page_name = page_name | remove: '/' -%}
  {%- endif -%}
{%- endif -%}

{%- if page.title == 'Diaporama' -%}
    {% assign images = site.data.diaporama %}
    {% assign first_image = images[0] %}
    {% assign image_subdir = "/" %}
    {% assign dindex = "" %}
{%- elsif page.date -%}
    {% assign date_parts = page.date | split: " " %}
    {% assign page_name = date_parts[0] %}
    {% assign images = site.data.posts[page_name] %}
    {% assign first_image = images[0] %}
    {% assign image_subdir = "/posts/" | append: page_name | append: "/" %}
    {% assign dindex = page_name | replace: "-", "" %}
{%- else -%}
    {% assign images = site.data.images[page_name] %}
    {% assign first_image = images[0] %}
    {% assign image_subdir = page.permalink %}
    {% assign dindex = "" %}    
{%- endif -%}

{%- if first_image != nil  -%}
<div id="slideshow{{ dindex }}">
    <div class="slide" style="background-image: url('/images{{ image_subdir }}{{ first_image.image }}');">
        <div class="slide-text">{{ first_image.alt }}</div>
    </div>

    <div class="slideshow-controls">
        <button id="prev{{ dindex }}" class="slideshow-button">&lt;</button>
        <button id="next{{ dindex }}" class="slideshow-button">&gt;</button>
    </div>

    {% if page.leaflet %}
    <div class="map-container" id="map{{ dindex }}"></div>
    {% endif %}
      
</div>

<script>
    let images{{ dindex }} = [
        {% for image in images %}
            {
                src: "{{ image.image }}",
                alt: "{{ image.alt | escape }}"
                {% if image.lat and image.lon %}
                    , lat: {{ image.lat }},
                    lon: {{ image.lon }}
                {% endif %}
            }{% unless forloop.last %},{% endunless %}
        {% endfor %}
    ];

document.addEventListener('DOMContentLoaded', function() {
    const slideshowContainer{{ dindex }} = document.querySelector('#slideshow{{ dindex }} .slide'); // Sélectionnez la div .slide
    let currentSlide{{ dindex }} = 0;
    let map{{ dindex }};
    let markers{{ dindex }} = [];

    function showSlide{{ dindex }}(index) {
        const image = images{{ dindex }}[index];
        currentSlide{{ dindex }} = index;

        // Modifiez le style de fond pour changer l'image
        slideshowContainer{{ dindex }}.style.backgroundImage = `url("/images{{ image_subdir }}${image.src}")`;
        // Modifiez le texte de l'alt pour la nouvelle image
        const slideTextDiv = slideshowContainer{{ dindex }}.querySelector('.slide-text');
        realindex=index+1;
        slideTextDiv.textContent = image.alt+" "+realindex+"/"+images{{ dindex }}.length;

        {% if page.leaflet %}

        // Mettre à jour les marqueurs
        map{{ dindex }}.panTo(new L.LatLng(images{{ dindex }}[index].lat, images{{ dindex }}[index].lon));

        markers{{ dindex }}.forEach((marker, idx) => {
            if (idx === index) {
                marker._icon.classList.add('active');
                marker.setZIndexOffset(1000);
            } else {
                marker._icon.classList.remove('active');
                marker.setZIndexOffset(0);
            }
        });

        {% endif %}

    }

    function initializeMap(){
        // Initialisation de la carte Leaflet
        map{{ dindex }} = L.map('map{{ dindex }}').setView([images{{ dindex }}[0].lat, images{{ dindex }}[0].lon], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'tcrouzet.com'
        }).addTo(map{{ dindex }});

        images{{ dindex }}.forEach((image, index) => {
            let marker = L.marker([image.lat, image.lon], {
                icon: L.divIcon({ className: 'my-custom-icon' })
            }).addTo(map{{ dindex }});

            marker.myIndex = index;

            markers{{ dindex }}.push(marker);
        });

        markers{{ dindex }}.forEach(marker => {
            marker.on('click', function() {
                showSlide{{ dindex }}(this.myIndex);
            });
        });
    }

    function adjustSlideshowSize() {
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight*0.9;

        // Calculer la taille maximale du diaporama tout en respectant le ratio 4/3
        let slideshowHeight = viewportHeight;
        let slideshowWidth = slideshowHeight * 4 / 3;

        if (slideshowWidth > viewportWidth) {
            slideshowWidth = viewportWidth;
            slideshowHeight = slideshowWidth * 3 / 4;
        }

        // Appliquer les dimensions calculées
        const slideshow = document.getElementById('slideshow{{ dindex }}');
        if (slideshow) {
            slideshow.style.width = `${slideshowWidth}px`;
            slideshow.style.height = `${slideshowHeight}px`;
        }

        {% if page.leaflet %}
        initializeMap();
        {% endif %}
        showSlide{{ dindex }}(currentSlide{{ dindex }});

    }

    document.getElementById('prev{{ dindex }}').addEventListener('click', () => {
        currentSlide{{ dindex }} = currentSlide{{ dindex }} - 1 < 0 ? images{{ dindex }}.length - 1 : currentSlide{{ dindex }} - 1;
        showSlide{{ dindex }}(currentSlide{{ dindex }});
    });

    document.getElementById('next{{ dindex }}').addEventListener('click', () => {
        currentSlide{{ dindex }} = (currentSlide{{ dindex }} + 1) % images{{ dindex }}.length;
        showSlide{{ dindex }}(currentSlide{{ dindex }});
    });

    window.addEventListener('load', adjustSlideshowSize);
    window.addEventListener('resize', adjustSlideshowSize);

});




</script>

<style type="text/css">

#slideshow{{ dindex }} {
    width: 100%; /* Utiliser toute la largeur disponible */
    margin: auto;
    position: relative;
    overflow: hidden;
}

#slideshow{{ dindex }} .slide {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-position: center;
    background-size: contain; /* Assurer que toute l'image est visible */
    background-repeat: no-repeat;
}

#slideshow{{ dindex }} .slideshow-controls {
    position: relative;
    width: 100%;
    top: 35%;
    /*transform: translateY(-50%);*/
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 10; /* S'assure que les contrôles sont au-dessus de l'image */
}

#slideshow{{ dindex }} .map-container {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30%;
    height: 20%;
    z-index: 3;
}

</style>
{%- endif -%}

<!-- END Slideshow -->